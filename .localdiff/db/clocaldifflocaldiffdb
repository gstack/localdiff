{"k":"0000000078","o":"0000007733","v":"001"}
{"_id":2,"_uid":2,"_dt":1419353365614,"_s":"42111647fac518d706a196cca018343c"}
{"key":"clocaldiffindexjs","path":"C:\\localdiff\\index.js","lastUpdate":1419353340021,"revisions":[{"timestamp":1419353340021,"diff":""},{"timestamp":1419353342599,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\index.js2\t2014-12-23 08:49:02.562787000 -0800\r\n+++ C:\\localdiff\\index.js\t2014-12-23 08:49:02.554779700 -0800\r\n@@ -23,7 +23,6 @@\r\n .describe('dir', \"folder with the files to watch and create a diff log for\")\r\n .argv;\r\n \r\n-//util.log(argv.dir);\r\n global.argv = argv;\r\n \r\n global.db = null;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\index-revs\\index(1419353342599).js"},{"timestamp":1419353365608,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\index.js1\t2014-12-23 08:49:25.579127300 -0800\r\n+++ C:\\localdiff\\index.js\t2014-12-23 08:49:25.555110500 -0800\r\n@@ -23,7 +23,6 @@\r\n .describe('dir', \"folder with the files to watch and create a diff log for\")\r\n .argv;\r\n \r\n-//util.log(argv.dir);\r\n global.argv = argv;\r\n \r\n global.db = null;\r\n@@ -56,6 +55,7 @@\r\n   }\r\n });\r\n \r\n+// after data dir is initially created\r\n function makeInnerDirs() {\r\n   fs.mkdir(STORAGE_DIR,function(e){\r\n     if(!e || (e && e.code === 'EEXIST')) {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\index-revs\\index(1419353365608).js"}],"previous":"Ly8gYWxsIHRoZSBwcm9qZWN0IHJlcXVpcmVtZW50cw0KLy92YXIgRW5naW5lID0gcmVxdWlyZSgndGluZ29kYicpKCksDQp2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKSwNCmFzc2VydCA9IHJlcXVpcmUoJ2Fzc2VydCcpLA0KZnMgPSByZXF1aXJlKCdmcycpLA0KdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKSwNCmNob2tpZGFyID0gcmVxdWlyZSgnY2hva2lkYXInKSwNCmNvbG9ycyA9IHJlcXVpcmUoJ2NvbG9ycycpLA0KLyogYW5vdGhlciBsaWIgaSB3YW5uYSBleHRlbmQgcmlnaHQgaGVyZSAtIGJhc2Vwb3J0IG5lZWRuJ3QgYmUgYSBzaW5nbGUgb25lLCB5YWRpZGltZWFuPyAqLw0KcG9ydGZpbmRlciA9IHJlcXVpcmUoJ3BvcnRmaW5kZXInKTsNCg0KLyogdGhlIGN1c3RvbSBkaWZmd2F0Y2ggbGliIHdlIHdyaXRlIGZvciB0aGlzIHByb2plY3QgKi8NCnZhciBkaWZmd2F0Y2ggPSByZXF1aXJlKCcuL2RpZmZ3YXRjaCcpLkRpZmZXYXRjaGVyOw0KDQp2YXIgYXJndiA9IHJlcXVpcmUoJ29wdGltaXN0JykNCi51c2FnZSgnVXNhZ2U6ICQwIC1kaXI9IkM6L3BhdGgvdG8vZmlsZSInKQ0KLmRlZmF1bHQoJ2RpcicsIHBhdGguam9pbihwcm9jZXNzLmN3ZCgpKSkNCi5kZWZhdWx0KCdkYnBhdGgnLCBudWxsKQ0KLmRlZmF1bHQoJ3N0b3JhZ2UnLCBudWxsKQ0KLmRlZmF1bHQoJ3NhdmVyZXZpc2lvbnMnLCB0cnVlKQ0KLmRlZmF1bHQoJ2RicmV2aXNpb25zJywgZmFsc2UpDQouZGVmYXVsdCgndXNlbW9uZ28nLCBmYWxzZSkNCi5kZXNjcmliZSgnZGlyJywgImZvbGRlciB3aXRoIHRoZSBmaWxlcyB0byB3YXRjaCBhbmQgY3JlYXRlIGEgZGlmZiBsb2cgZm9yIikNCi5hcmd2Ow0KDQovL3V0aWwubG9nKGFyZ3YuZGlyKTsNCmdsb2JhbC5hcmd2ID0gYXJndjsNCg0KZ2xvYmFsLmRiID0gbnVsbDsNCmdsb2JhbC5jb25uZWN0aW9uID0gbnVsbDsNCg0KdmFyIFdPUktJTkdfRElSID0gYXJndi5kaXI7DQp2YXIgREFUQV9ESVIgPSBwYXRoLmpvaW4oV09SS0lOR19ESVIsICcubG9jYWxkaWZmJyk7DQp2YXIgREJfRElSID0gYXJndi5kYnBhdGggfHwgcGF0aC5qb2luKERBVEFfRElSLCAnZGInKTsNCnZhciBTVE9SQUdFX0RJUiA9IGFyZ3Yuc3RvcmFnZSB8fCBwYXRoLmpvaW4oREFUQV9ESVIsICdzdG9yYWdlJyk7DQp2YXIgVE1QX0RJUiA9IHBhdGguam9pbihEQl9ESVIsICd0ZW1wJyk7DQoNCmdsb2JhbC5kaWZmV2F0Y2hPcHRzID0gew0KICB3b3JraW5nUGF0aDogV09SS0lOR19ESVIsDQogIGRiUGF0aDogREJfRElSLA0KICB0ZW1wUGF0aDogVE1QX0RJUiwNCiAgcmV2SGlzdG9yeTogZ2xvYmFsLmFyZ3Yuc2F2ZXJldmlzaW9ucywNCiAgZGJIaXN0b3J5OiBnbG9iYWwuYXJndi5kYnJldmlzaW9ucywNCg0KICBkYjogbnVsbCwNCiAgcHJvamVjdDogbnVsbCwNCn07DQoNCg0KZnMubWtkaXIoREFUQV9ESVIsZnVuY3Rpb24oZSl7DQogIGlmKCFlIHx8IChlICYmIGUuY29kZSA9PT0gJ0VFWElTVCcpKSB7DQogICAgbWFrZUlubmVyRGlycygpOw0KICB9IGVsc2Ugew0KICAgIHV0aWwubG9nKGNvbG9ycy5yZWQoZSkpOw0KICAgIHV0aWwubG9nKGNvbG9ycy5yZWQoJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK1NUT1JBR0VfRElSKSk7DQogIH0NCn0pOw0KDQpmdW5jdGlvbiBtYWtlSW5uZXJEaXJzKCkgew0KICBmcy5ta2RpcihTVE9SQUdFX0RJUixmdW5jdGlvbihlKXsNCiAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgew0KICAgICAgZ2xvYmFsLmRpZmZXYXRjaE9wdHMuc3RvcmFnZURpciA9IFNUT1JBR0VfRElSOw0KICAgIH0gZWxzZSB7DQogICAgICB1dGlsLmxvZyhjb2xvcnMucmVkKGUpKTsNCiAgICAgIHV0aWwubG9nKGNvbG9ycy5yZWQoJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK1NUT1JBR0VfRElSKSk7DQogICAgfQ0KICB9KQ0KDQogIC8vIGVuc3VyZSB0aGUgREIgYW5kIFRNUCBkaXIgZXhpc3QsIGlmIG5vdCBjcmVhdGUgdGhlbQ0KICBmcy5ta2RpcihEQl9ESVIsZnVuY3Rpb24oZSl7DQogICAgaWYoIWUgfHwgKGUgJiYgZS5jb2RlID09PSAnRUVYSVNUJykpIHsNCg0KICAgICAgZnMubWtkaXIoVE1QX0RJUixmdW5jdGlvbihlKXsNCiAgICAgICAgaWYoIWUgfHwgKGUgJiYgZS5jb2RlID09PSAnRUVYSVNUJykpIHsNCiAgICAgICAgICBjb25uZWN0RGIoREJfRElSKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB1dGlsLmxvZyhjb2xvcnMucmVkKGUpKTsNCiAgICAgICAgICB1dGlsLmxvZyhjb2xvcnMucmVkKCdjb3VsZCBub3QgZ2VuZXJhdGUgdGVtcG9yYXJ5IGRpcjogJytEQl9ESVIpKTsNCiAgICAgICAgfQ0KICAgICAgfSk7DQoNCiAgICB9IGVsc2Ugew0KICAgICAgdXRpbC5sb2coY29sb3JzLnJlZChlKSk7DQogICAgICB1dGlsLmxvZyhjb2xvcnMucmVkKCdjb3VsZCBub3QgY29ubmVjdCB0byBkYjogJytEQl9ESVIpKTsNCiAgICB9DQogIH0pOw0KfQ0KDQpmdW5jdGlvbiBnZXREYihkaXIpDQp7DQogIGlmIChnbG9iYWwuZGIpIHJldHVybiBkYjsNCiAgaWYgKGFyZ3YudXNlbW9uZ28pIHsNCiAgICB1dGlsLmxvZyhjb2xvcnMuZ3JheSgndXNpbmcgbW9uZ29kYicpKTsNCiAgICBnbG9iYWwuZW5naW5lID0gcmVxdWlyZSgibW9uZ29kYiIpOw0KICAgIHZhciBkYjsNCiAgICBpZiAoIWRiKSBkYiA9IG5ldyBlbmdpbmUuRGIoY2ZnLm1vbmdvLmRiLA0KICAgICAgbmV3IGVuZ2luZS5TZXJ2ZXIoYXJndi5tb25nby5ob3N0LCBwYXJzZUludChhcmd2Lm1vbmdvLnBvcnQpLCBhcmd2Lm1vbmdvKSwNCiAgICAgIHsNCiAgICAgICAgbmF0aXZlX3BhcnNlcjogZmFsc2UsIHNhZmU6dHJ1ZQ0KICAgICAgfSk7DQogICAgZGIuZW5naW5lID0gZ2xvYmFsLmVuZ2luZTsNCiAgICByZXR1cm4gZGI7DQogIH0gZWxzZSB7DQogICAgdXRpbC5sb2coY29sb3JzLmdyYXkoJ3VzaW5nIHRpbmdvZGInKSk7DQogICAgZ2xvYmFsLmVuZ2luZSA9IHJlcXVpcmUoInRpbmdvZGIiKSh7fSk7DQogICAgdmFyIGRiOw0KICAgIGlmICghZGIpIGRiID0gbmV3IGVuZ2luZS5EYihkaXIsIHt9KTsNCiAgICBkYi5lbmdpbmUgPSBnbG9iYWwuZW5naW5lOw0KICAgIHJldHVybiBkYjsNCiAgfQ0KfQ0KDQovLyBjcmVhdGUgdGhlIGRiIGNvbm5lY3Rpb24gKyBzdGFydCB0aGUgdmlld2luZyBzZXJ2ZXINCmZ1bmN0aW9uIGNvbm5lY3REYihkaXIpDQp7DQogIHV0aWwubG9nKCdjb25uZWN0aW5nIHRvIGRiJyk7DQoNCiAgdmFyIGRiID0gZ2V0RGIoZGlyKTsNCiAgZ2xvYmFsLmRpZmZXYXRjaE9wdHMuZGIgPSBkYjsNCg0KICB2YXIgY29sbGVjdGlvblN0ciA9IGRpci50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXFcvZywgJycpOw0KICBnbG9iYWwuZGlmZldhdGNoT3B0cy5jb2xsZXRpb24gPSBjb2xsZWN0aW9uU3RyOw0KDQogIHZhciBwcm9qZWN0ID0gZGIucHJvamVjdCA9IGdsb2JhbC5kaWZmV2F0Y2hPcHRzLnByb2plY3QgPSBkYi5jb2xsZWN0aW9uKGNvbGxlY3Rpb25TdHIpOw0KICB2YXIgb3B0aW9ucyA9IGRiLnByb2plY3RPcHRpb25zID0gZ2xvYmFsLmRpZmZXYXRjaE9wdHMucHJvamVjdE9wdGlvbnMgPSBkYi5jb2xsZWN0aW9uKGNvbGxlY3Rpb25TdHIrJ19vcHRpb25zJyk7DQoNCiAgdXRpbC5sb2coY29sb3JzLmdyZWVuKCdkYiByZWFkeSArIHByb2plY3QgY29sbGVjdGlvbjogJytjb2xsZWN0aW9uU3RyKSk7DQoNCiAgLy8gdG9kbzogY291bnQgLyBzYXZlIHRvIGRiDQogIHZhciB0cmFja2VkQ291bnQgPSAwOw0KDQogIHBvcnRmaW5kZXIuYmFzZVBvcnQgPSA5MDAwOw0KICBwb3J0ZmluZGVyLmdldFBvcnQoZnVuY3Rpb24oZXJyLCBwb3J0KSB7DQogICAgaWYgKGVycikgew0KICAgICAgdXRpbC5sb2coY29sb3JzLnJlZCgiY2FuJ3QgZ2V0IHBvcnQuIitlcnIpKTsNCiAgICAgIHJldHVybjsNCiAgICB9DQogICAgZ2xvYmFsLmh0dHBQb3J0ID0gcG9ydDsNCiAgICB1dGlsLmxvZyhjb2xvcnMuZ3JheSgndXNpbmcgaHR0cCBwb3J0OiAnK3BvcnQpKTsNCg0KICAgIHNlcnZlSHR0cChXT1JLSU5HX0RJUiwgcG9ydCk7DQogICAgcnVuKCk7DQogIH0pOw0KDQogIC8qDQogIGNvbGxlY3Rpb24uZmluZCh7aGVsbG86J3dvcmxkX3NhZmUyJ30pLnRvQXJyYXkoZnVuY3Rpb24oZXJyLCBpdGVtKSB7DQogICAgdXRpbC5sb2coJy0tLS0nKTsNCiAgICBjb25zb2xlLmRpcihpdGVtKTsNCiAgfSk7DQoNCiAgY29sbGVjdGlvbi5pbnNlcnQoW3thOjEsIGI6MX0sIHthOjIsIGI6Mn0sIHthOjMsIGI6M31dLCB7dzoxfSwgZnVuY3Rpb24oZXJyLCByZXN1bHQpIHsNCiAgYXNzZXJ0LmVxdWFsKG51bGwsIGVycik7DQogICk7DQogICovDQp9DQoNCmZ1bmN0aW9uIHNlcnZlSHR0cChwYXRoLCBwb3J0KQ0Kew0KICB2YXIgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTsNCiAgdmFyIGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7DQogIHZhciBzZXhzdGF0aWMgPSByZXF1aXJlKCdzZXhzdGF0aWMnKTsNCg0KICB2YXIgYXBwID0gZXhwcmVzcygpOw0KICBhcHAudXNlKHNleHN0YXRpYyh7IHJvb3Q6IHBhdGggfSkpOw0KICBodHRwLmNyZWF0ZVNlcnZlcihhcHApLmxpc3Rlbihwb3J0KTsNCg0KICB1dGlsLmxvZyhjb2xvcnMuZ3JlZW4oJ3NlcnZpbmcgaHR0cCBwb3J0IG9uIGh0dHA6Ly8xMjcuMC4wLjE6Jytwb3J0KycvJykpOw0KfQ0KDQovLyBjYWxsZWQgb25jZSBldmVyeXRoaW5nIGlzIHNldHVwLg0KZnVuY3Rpb24gcnVuKCkNCnsNCiAgZ2xvYmFsLmRpZmZfd2F0Y2ggPSBuZXcgZGlmZndhdGNoKGdsb2JhbC5kaWZmV2F0Y2hPcHRzKTsNCn0NCg0KdXRpbC5sb2coY29sb3JzLndoaXRlKCdydW4nKSk7DQo=","lastDiff":"","_id":{"$wrap":"$oid","v":2}}
{"k":"0000000078","o":"0000046246","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354164121,"_s":"ba3e82be9955d7e2417d4096895313f2"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419353394175,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgbGFzdERpZmY6IG9iai5kaWZmLAogICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgZHcuaW5mbygicmV2aXNpb24gaGlzdG9yeSBmb3IgIitvbmVJZCsiOiAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBlbnRyeS5sYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGVudHJ5Lmxhc3REaWZmKTsKCgogICAgICAgIC8vZnMud3JpdGVGaWxlU3luYygndGVzdC5qc29uJywgSlNPTi5zdHJpbmdpZnkoZW50cnkpKTsKICAgICAgICAvL2R3LmRlYnVnKCd3cm90ZSBkZWJ1ZyB0ZXN0Lmpzb24nKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICAgIGxhc3REaWZmOiBvYmouZGlmZiwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000010255","v":"001"}
{"_id":4,"_uid":4,"_dt":1419353987879,"_s":"bc486430adfcbb94c2b4f8e54fcf61db"}
{"key":"clocaldiffmodulesutilsjs","path":"C:\\localdiff\\modules\\utils.js","lastUpdate":1419353895955,"revisions":[{"timestamp":1419353895955,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js4\t2014-12-23 08:58:15.926084500 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:58:15.917077700 -0800\r\n@@ -70,4 +70,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n"},{"timestamp":1419353907171,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js5\t2014-12-23 08:58:27.142519200 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:58:27.122505900 -0800\r\n@@ -1,7 +1,7 @@\r\n var util = require('util'),\r\n     colors = require('colors');\r\n \r\n-var DiffWatchUtils = {\r\n+global.DiffWatchUtils = {\r\n   debug: true\r\n };\r\n \r\n@@ -70,4 +70,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\utils-revs\\utils(1419353907171).js"},{"timestamp":1419353924013,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js6\t2014-12-23 08:58:43.975251600 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:58:43.958239900 -0800\r\n@@ -1,7 +1,7 @@\r\n var util = require('util'),\r\n     colors = require('colors');\r\n \r\n-var DiffWatchUtils = {\r\n+global.DiffWatchUtils = {\r\n   debug: true\r\n };\r\n \r\n@@ -33,6 +33,8 @@\r\n \r\n DiffWatchUtils.debug = function(m)\r\n {\r\n+  if (!global.DiffWatchUtils.debug) return;\r\n+\r\n   if (arguments.length > 1)\r\n   {\r\n     m = Array.prototype.slice.call(arguments);\r\n@@ -70,4 +72,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\utils-revs\\utils(1419353924013).js"},{"timestamp":1419353938072,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js7\t2014-12-23 08:58:58.041346800 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:58:58.035342400 -0800\r\n@@ -1,11 +1,11 @@\r\n var util = require('util'),\r\n     colors = require('colors');\r\n \r\n-var DiffWatchUtils = {\r\n+global.DiffWatchUtils = {\r\n   debug: true\r\n };\r\n \r\n-DiffWatchUtils.success = function(m)\r\n+global.DiffWatchUtils.success = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -18,7 +18,7 @@\r\n   util.log(colors.green(m));\r\n }\r\n \r\n-DiffWatchUtils.info = function(m)\r\n+global.DiffWatchUtils.info = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -31,8 +31,10 @@\r\n     util.log(colors.white(m));\r\n   }\r\n \r\n-DiffWatchUtils.debug = function(m)\r\n+global.DiffWatchUtils.debug = function(m)\r\n {\r\n+  if (!global.DiffWatchUtils.debug) return;\r\n+\r\n   if (arguments.length > 1)\r\n   {\r\n     m = Array.prototype.slice.call(arguments);\r\n@@ -44,7 +46,7 @@\r\n   util.log(colors.cyan(m));\r\n }\r\n \r\n-DiffWatchUtils.warn = function(m)\r\n+global.DiffWatchUtils.warn = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -57,7 +59,7 @@\r\n   util.log(colors.yellow(m));\r\n }\r\n \r\n-DiffWatchUtils.error = function(m)\r\n+global.DiffWatchUtils.error = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -70,4 +72,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\utils-revs\\utils(1419353938072).js"},{"timestamp":1419353959953,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js1\t2014-12-23 08:59:19.928385000 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:59:19.890359800 -0800\r\n@@ -1,11 +1,12 @@\r\n var util = require('util'),\r\n     colors = require('colors');\r\n \r\n-var DiffWatchUtils = {\r\n+// heh\r\n+global.DiffWatchUtils = {\r\n   debug: true\r\n };\r\n \r\n-DiffWatchUtils.success = function(m)\r\n+global.DiffWatchUtils.success = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -18,7 +19,7 @@\r\n   util.log(colors.green(m));\r\n }\r\n \r\n-DiffWatchUtils.info = function(m)\r\n+global.DiffWatchUtils.info = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -31,8 +32,10 @@\r\n     util.log(colors.white(m));\r\n   }\r\n \r\n-DiffWatchUtils.debug = function(m)\r\n+global.DiffWatchUtils.debug = function(m)\r\n {\r\n+  if (!global.DiffWatchUtils.debug) return;\r\n+\r\n   if (arguments.length > 1)\r\n   {\r\n     m = Array.prototype.slice.call(arguments);\r\n@@ -44,7 +47,7 @@\r\n   util.log(colors.cyan(m));\r\n }\r\n \r\n-DiffWatchUtils.warn = function(m)\r\n+global.DiffWatchUtils.warn = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -57,7 +60,7 @@\r\n   util.log(colors.yellow(m));\r\n }\r\n \r\n-DiffWatchUtils.error = function(m)\r\n+global.DiffWatchUtils.error = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -70,4 +73,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\utils-revs\\utils(1419353959953).js"},{"timestamp":1419353974006,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js2\t2014-12-23 08:59:33.987154200 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:59:33.970141300 -0800\r\n@@ -1,11 +1,12 @@\r\n var util = require('util'),\r\n     colors = require('colors');\r\n \r\n-var DiffWatchUtils = {\r\n+// heh ;)\r\n+global.DiffWatchUtils = {\r\n   debug: true\r\n };\r\n \r\n-DiffWatchUtils.success = function(m)\r\n+global.DiffWatchUtils.success = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -18,7 +19,7 @@\r\n   util.log(colors.green(m));\r\n }\r\n \r\n-DiffWatchUtils.info = function(m)\r\n+global.DiffWatchUtils.info = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -31,8 +32,10 @@\r\n     util.log(colors.white(m));\r\n   }\r\n \r\n-DiffWatchUtils.debug = function(m)\r\n+global.DiffWatchUtils.debug = function(m)\r\n {\r\n+  if (!global.DiffWatchUtils.debug) return;\r\n+\r\n   if (arguments.length > 1)\r\n   {\r\n     m = Array.prototype.slice.call(arguments);\r\n@@ -44,7 +47,7 @@\r\n   util.log(colors.cyan(m));\r\n }\r\n \r\n-DiffWatchUtils.warn = function(m)\r\n+global.DiffWatchUtils.warn = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -57,7 +60,7 @@\r\n   util.log(colors.yellow(m));\r\n }\r\n \r\n-DiffWatchUtils.error = function(m)\r\n+global.DiffWatchUtils.error = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -70,4 +73,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\utils-revs\\utils(1419353974006).js"},{"timestamp":1419353987876,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\utils.js3\t2014-12-23 08:59:47.855446300 -0800\r\n+++ C:\\localdiff\\modules\\utils.js\t2014-12-23 08:59:47.833431700 -0800\r\n@@ -1,11 +1,12 @@\r\n var util = require('util'),\r\n     colors = require('colors');\r\n \r\n-var DiffWatchUtils = {\r\n+// heh..\r\n+global.DiffWatchUtils = {\r\n   debug: true\r\n };\r\n \r\n-DiffWatchUtils.success = function(m)\r\n+global.DiffWatchUtils.success = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -18,7 +19,7 @@\r\n   util.log(colors.green(m));\r\n }\r\n \r\n-DiffWatchUtils.info = function(m)\r\n+global.DiffWatchUtils.info = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -31,8 +32,10 @@\r\n     util.log(colors.white(m));\r\n   }\r\n \r\n-DiffWatchUtils.debug = function(m)\r\n+global.DiffWatchUtils.debug = function(m)\r\n {\r\n+  if (!global.DiffWatchUtils.debug) return;\r\n+\r\n   if (arguments.length > 1)\r\n   {\r\n     m = Array.prototype.slice.call(arguments);\r\n@@ -44,7 +47,7 @@\r\n   util.log(colors.cyan(m));\r\n }\r\n \r\n-DiffWatchUtils.warn = function(m)\r\n+global.DiffWatchUtils.warn = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -57,7 +60,7 @@\r\n   util.log(colors.yellow(m));\r\n }\r\n \r\n-DiffWatchUtils.error = function(m)\r\n+global.DiffWatchUtils.error = function(m)\r\n {\r\n   if (arguments.length > 1)\r\n   {\r\n@@ -70,4 +73,4 @@\r\n   util.log(colors.red(m));\r\n }\r\n \r\n-module.exports = global.DiffWatchUtils || DiffWatchUtils;\r\n+module.exports = global.DiffWatchUtils;\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\utils-revs\\utils(1419353987876).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKTsKCnZhciBEaWZmV2F0Y2hVdGlscyA9IHsKICBkZWJ1ZzogdHJ1ZQp9OwoKRGlmZldhdGNoVXRpbHMuc3VjY2VzcyA9IGZ1bmN0aW9uKG0pCnsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpCiAgewogICAgbSA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgfQoKICBpZiAodXRpbC5pc0FycmF5KG0pKQogICAgbSA9IG0uam9pbignICcpOwoKICB1dGlsLmxvZyhjb2xvcnMuZ3JlZW4obSkpOwp9CgpEaWZmV2F0Y2hVdGlscy5pbmZvID0gZnVuY3Rpb24obSkKewogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkKICB7CiAgICBtID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICB9CgogIGlmICh1dGlsLmlzQXJyYXkobSkpCiAgICBtID0gbS5qb2luKCcgJyk7CgogICAgdXRpbC5sb2coY29sb3JzLndoaXRlKG0pKTsKICB9CgpEaWZmV2F0Y2hVdGlscy5kZWJ1ZyA9IGZ1bmN0aW9uKG0pCnsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpCiAgewogICAgbSA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgfQoKICBpZiAodXRpbC5pc0FycmF5KG0pKQogICAgbSA9IG0uam9pbignICcpOwoKICB1dGlsLmxvZyhjb2xvcnMuY3lhbihtKSk7Cn0KCkRpZmZXYXRjaFV0aWxzLndhcm4gPSBmdW5jdGlvbihtKQp7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKQogIHsKICAgIG0gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogIH0KCiAgaWYgKHV0aWwuaXNBcnJheShtKSkKICAgIG0gPSBtLmpvaW4oJyAnKTsKCiAgdXRpbC5sb2coY29sb3JzLnllbGxvdyhtKSk7Cn0KCkRpZmZXYXRjaFV0aWxzLmVycm9yID0gZnVuY3Rpb24obSkKewogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkKICB7CiAgICBtID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICB9CgogIGlmICh1dGlsLmlzQXJyYXkobSkpCiAgICBtID0gbS5qb2luKCcgJyk7CgogIHV0aWwubG9nKGNvbG9ycy5yZWQobSkpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5EaWZmV2F0Y2hVdGlscyB8fCBEaWZmV2F0Y2hVdGlsczsK","_id":{"$wrap":"$oid","v":4}}
{"k":"0000000078","o":"0000046258","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354189687,"_s":"c0a0dd85a955ab2b254db40669d0c317"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354189675,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgdmFyIGxhc3REaWZmID0gZW50cnkucmV2aXNpb25zW2VudHJ5LnJldmlzaW9ucy5sZW5ndGgtMV0uZGlmZiB8fCBudWxsOwogICAgICAgIGR3LmluZm8oInJldmlzaW9uIGhpc3RvcnkgZm9yICIrb25lSWQrIiBjb250YWlucyAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBsYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGxhc3REaWZmKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000048205","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354189691,"_s":"aba4c5c745b5d23b5d015cf7af0dad72"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354189675,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgdmFyIGxhc3REaWZmID0gZW50cnkucmV2aXNpb25zW2VudHJ5LnJldmlzaW9ucy5sZW5ndGgtMV0uZGlmZiB8fCBudWxsOwogICAgICAgIGR3LmluZm8oInJldmlzaW9uIGhpc3RvcnkgZm9yICIrb25lSWQrIiBjb250YWlucyAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBsYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGxhc3REaWZmKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000048233","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354199366,"_s":"903357741027fe1401f0b01cc105e98b"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354199363,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICAvLyBzZWUgaG93IHRoYXQgaXMKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgdmFyIGxhc3REaWZmID0gZW50cnkucmV2aXNpb25zW2VudHJ5LnJldmlzaW9ucy5sZW5ndGgtMV0uZGlmZiB8fCBudWxsOwogICAgICAgIGR3LmluZm8oInJldmlzaW9uIGhpc3RvcnkgZm9yICIrb25lSWQrIiBjb250YWlucyAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBsYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGxhc3REaWZmKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000048654","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354199371,"_s":"cd547932267d6765ace344fb00e2d231"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354199363,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"},{"timestamp":1419354199360,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 09:03:19.340250400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:19.295220100 -0800\r\n@@ -68,6 +68,7 @@\r\n     }\r\n   });\r\n \r\n+  // see how that is\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354199360).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICAvLyBzZWUgaG93IHRoYXQgaXMKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgdmFyIGxhc3REaWZmID0gZW50cnkucmV2aXNpb25zW2VudHJ5LnJldmlzaW9ucy5sZW5ndGgtMV0uZGlmZiB8fCBudWxsOwogICAgICAgIGR3LmluZm8oInJldmlzaW9uIGhpc3RvcnkgZm9yICIrb25lSWQrIiBjb250YWlucyAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBsYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGxhc3REaWZmKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000048690","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354204743,"_s":"4cabc2f83067bce16950c99d8a156931"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354204737,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"},{"timestamp":1419354199360,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 09:03:19.340250400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:19.295220100 -0800\r\n@@ -68,6 +68,7 @@\r\n     }\r\n   });\r\n \r\n+  // see how that is\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354199360).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICAvLyBzZWUgaG93IHRoYXQgaXMKICAvLyBhY3R1YWxseSB3b3JrcyBsbWFvCiAgcHJvamVjdC51cGRhdGUoCiAgeyBfaWQ6IG9uZUlkIH0sCiAgewogICAga2V5OiBvYmoua2V5LAogICAgJHB1c2g6IHsgcmV2aXNpb25zOiByZWNvcmQgfQogIH0sCiAgZnVuY3Rpb24oZXJyLCByZXN1bHQpIHsKICAgIGlmIChlcnIgIT0gbnVsbCkgewogICAgICBkdy5lcnJvcignZXJyb3Igc2F2aW5nIHRvIGRiJywgZXJyKTsKICAgICAgZHcuZXJyb3IoZXJyLnN0YWNrKTsKICAgIH0KCiAgICBwcm9qZWN0LmZpbmRPbmUoeyBfaWQ6IG9uZUlkIH0sIGZ1bmN0aW9uKGVyciwgZW50cnkpewogICAgICAvLyBjaGVjayBmb3IgZXJyb3IKICAgICAgaWYgKGVyciAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoZXJyKTsKICAgICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gbWFrZSBzdXJlIGVudHJ5IGlzIHRoZXJlIC8gdXBkYXRlZCB0ZXN0CiAgICAgIGlmIChlbnRyeSAhPSBudWxsICYmIGVudHJ5LnJldmlzaW9ucyAhPSBudWxsKQogICAgICB7CiAgICAgICAgLy8gc2hvdyBlbnRyeSBpbmZvIC8gdGVzdCBkZWJ1ZwogICAgICAgIHZhciBsYXN0RGlmZiA9IGVudHJ5LnJldmlzaW9uc1tlbnRyeS5yZXZpc2lvbnMubGVuZ3RoLTFdLmRpZmYgfHwgbnVsbDsKICAgICAgICBkdy5pbmZvKCJyZXZpc2lvbiBoaXN0b3J5IGZvciAiK29uZUlkKyIgY29udGFpbnMgIitlbnRyeS5yZXZpc2lvbnMubGVuZ3RoKyIgZW50cmllcy4iKTsKICAgICAgICBkdy5kZWJ1ZygndXBkYXRlZCBkaWZmIGxlbmd0aDogJywgbGFzdERpZmYubGVuZ3RoKTsKICAgICAgICBkdy5kZWJ1ZygnbGFzdCBkaWZmOiAnLCBsYXN0RGlmZik7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoZW50cnkgIT0gbnVsbCkKICAgICAgewogICAgICAgIGR3LmVycm9yKCdyZXZpc2lvbiBoaXN0b3J5IGZvciAnK29uZUlkKycgbnVsbCcpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIGR3LmVycm9yKCdyZXZpc2lvbiBoaXN0b3J5IC8gZW50cnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgIH0pOwogIH0pOyAvLyB1cGRhdGUgY2FsbGJhY2sgKGZpcnN0KQp9IC8vIGZuOnVwZGF0ZQoKLy8gc3RhcnQgbGlzdGVuaW5nIHRvIGNoYW5nZSBldmVudHMgKGNhbGxlZCBhZnRlciByZWFkeSkKZGlmZndhdGNoLnByb3RvdHlwZS5jaGVjayA9IGZ1bmN0aW9uKCkgewogIC8vIGNsb3N1cmUgLyB0aGlzIHNjb3BlCiAgdmFyIHNjb3BlID0gdGhpczsKICB2YXIgZGIgPSBzY29wZS5kYjsKCiAgdGhpcy53YXRjaGVyLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihmaWxlLCBzdGF0cykgewogICAgaWYgKGZpbGUuaW5kZXhPZigndGVtcCcpICE9IC0xKSByZXR1cm47CgogICAgdmFyIG5hbWUgPSBmaWxlLnRvTG93ZXJDYXNlKCk7CiAgICBpZiAoKG5hbWUuaW5kZXhPZignLmxvY2FsZGlmZicpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKCdkYicpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKCdzdG9yYWdlJykgIT0gLTEpIHx8IChuYW1lLmluZGV4T2YodGhpcy5zdG9yYWdlKSAhPSAtMSkgfHwgKGZpbGUuaW5kZXhPZihuYW1lLmRiUGF0aCkgIT0gLTEpKSB7CiAgICAgIGR3LmRlYnVnKCdmaWxlIHVwZGF0ZWQgaW4gaW50ZXJuYWwgZGlycy4gaWdub3JpbmcnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAvLyAgaWYgKGZpbGUuaW5kZXhPZignLmpzb24nKSAhPSAtMSkgcmV0dXJuOwogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcudHh0JykgIT0gLTEpIHJldHVybjsKCiAgICBkdy5kZWJ1ZygnRmlsZScsIGZpbGUsICdjaGFuZ2VkIHNpemUgdG8nLCBzdGF0cy5zaXplKTsKCiAgICB2YXIga2V5ID0gKGZpbGUrJycpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXFcvZywgJycpLnRvU3RyaW5nKCk7CiAgICB2YXIgcHJvamVjdCA9IHRoaXMucHJvamVjdDsKCiAgICAvLyBmaW5kIGV4aXN0aW5nIHJlY29yZCBieSBrZXkgaW4gZGIKICAgIHRoaXMucHJvamVjdC5maW5kT25lKHsga2V5OiBrZXkgfSwgZnVuY3Rpb24oZXJyLCBpdGVtKXsKICAgICAgaWYgKGVycikKICAgICAgewogICAgICAgIGR3LmVycm9yKCdkYicsIGVycik7CiAgICAgICAgZHcuZXJyb3IoJ3N0YWNrJywgZXJyLnN0YWNrKTsKICAgICAgICBkdy5pbmZvKCdrZXk6Jywga2V5KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChpdGVtID09IG51bGwpIHsKICAgICAgICBkdy5kZWJ1Zygnbm8gaXRlbSBmb3VuZCBmb3Iga2V5OicsIGtleSk7CgogICAgICAgIGlmIChvcmlnaW5hbHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAvLyBpZiB3ZSBoYXZlIHRoZSBvcmlnaW5hbCBzdGF0ZSBvZiB0aGUgZmlsZQogICAgICAgICAgLy8gYW5kIGl0J3MgY2hhbmdlZCwgZGlmZiBmcm9tIHRoYXQKICAgICAgICAgIGRpZmYoZmlsZSwgb3JpZ2luYWxzW2tleV0sIGZ1bmN0aW9uKHN1Y2Nlc3MsIG9iail7CiAgICAgICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBtZXcgcmV2aXNpb24gcmVjb3JkCiAgICAgICAgICAgICAgdmFyIHJlY29yZCA9IHsgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwgZGlmZjogb2JqLmRpZmYgfTsKCiAgICAgICAgICAgICAgcHJvamVjdC5pbnNlcnQoewogICAgICAgICAgICAgICAga2V5OiBvYmoua2V5LAogICAgICAgICAgICAgICAgcGF0aDogZmlsZSwKICAgICAgICAgICAgICAgIGxhc3RVcGRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgcmV2aXNpb25zOiBbIHJlY29yZCBdLAoKICAgICAgICAgICAgICAgIHByZXZpb3VzOiBvYmoudGV4dC50b1N0cmluZygnYmFzZTY0JyksCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3RyYWNraW5nIG5ldyBmaWxlICcrZmlsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZHcud2Fybignb3JpZ2luYWwgZGlmZiBmYWlsZWQgZm9yICcrZmlsZSsiIGluZm86ICIrSlNPTi5zdHJpbmdpZnkob2JqKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIGR3LmluZm8oJ3dpbGwgdHJhY2sgJytmaWxlKycgb24gbmV4dCBjaGFuZ2UgKHdhaXRpbmcgZm9yIG5ldyB2ZXJzaW9uKScpOwogICAgICAgICAgb3JpZ2luYWxzW2tleV0gPSBmcy5yZWFkRmlsZVN5bmMoZmlsZSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZHcuZXJyb3IoJ2RpZmYgY291bGQgbm90IGZpbmQgaXRlbSB3LyBrZXk6JytrZXkrJyBmb3IgZmlsZTonK2ZpbGUrJyAvIGRpZCBub3RoaW5nIGFib3V0IGl0LicpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gdXBkYXRlZAogICAgICBpZiAoaXRlbSAhPSBudWxsICYmIGl0ZW0ucHJldmlvdXMpCiAgICAgIHsKICAgICAgICB2YXIgb25lSWQgPSBpdGVtLl9pZDsKICAgICAgICBkdy5kZWJ1ZygnZXhpc3RpbmcgaXRlbSBrZXk6ICcsIGl0ZW0ua2V5LCAnIGlkOicsIG9uZUlkKTsKCiAgICAgICAgLy9kdy5kZWJ1ZygnaXRlbSBpZDonLCBvbmVJZCk7CiAgICAgICAgLy9kdy5kZWJ1ZygncnVubmluZyBkaWZmIGZvciAnK2ZpbGUrJyAvIGtleSAnK2l0ZW0ua2V5KTsKCiAgICAgICAgLy8gZmlsZSBoYXMgYSBsYXRlc3QgdmVyc2lvbiBzdG9yZWQgaW4gdGhlIGRiLCBzbyBkaWZmIGFnYWluc3QgdGhhdCBhbmQgc2F2ZSByZXN1bHQKICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBsYXRlc3Qgc2hvdWxkIGJlIHRoZSBsYXN0IHJldmlzaW9uCiAgICAgICAgZGlmZihmaWxlLCBuZXcgQnVmZmVyKGl0ZW0ucHJldmlvdXMsICdiYXNlNjQnKSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgIC8vIHVwZGF0ZQogICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIHd0Ziwgd2h5IHdvdWxkbid0IGl0ZW0gYiBoZXJlCiAgICAgICAgICAgIGR3LmRlYnVnKCdnb3QgbmV3IGRpZmYgZm9yICcrZmlsZSsnIHdpdGggaWQgJytvbmVJZCk7CgogICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwogICAgICAgICAgICBpZiAoc2NvcGUuZGJIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgIGR3LmRlYnVnKCdzYXZpbmcgaGlzdG9yeSBpbiBEQiBmb3InLCBvbmVJZCkKICAgICAgICAgICAgICAgcmVjb3JkLnRleHQgPSBvYmoudGV4dDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIHVzaW5nIHJldmlzaW9uIGhpc3RvcnksIG1vdmUgdGhlIHRtcCBmaWxlIHRvIHN0b3JhZ2UgLSB0aGVuIGNhbGwgdXBkYXRlLCBvciBjYWxsIHVwZGF0ZSB3aGVuCiAgICAgICAgICAgIC8vIGZpbmlzaGVkLgogICAgICAgICAgICBpZiAoc2NvcGUucmV2SGlzdG9yeSkKICAgICAgICAgICAgewogICAgICAgICAgICAgIC8vIGJhc2UgcGF0aCAoaWUgZm9sZGVyIG5hbWUgd2l0aG91dCBleHRlbnNpb24pCiAgICAgICAgICAgICAgcmVjb3JkLnNhdmVkX2F0ID0gcGF0aC5qb2luKHNjb3BlLnN0b3JhZ2UsIHBhdGguYmFzZW5hbWUoZmlsZSwgcGF0aC5leHRuYW1lKGZpbGUpKSsnLXJldnMnKTsKCiAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSByZXZpc2lvbnMgZm9sZGVyCiAgICAgICAgICAgICAgZnMubWtkaXIocmVjb3JkLnNhdmVkX2F0LGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgaWYoIWUgfHwgKGUgJiYgZS5jb2RlID09PSAnRUVYSVNUJykpIHsKICAgICAgICAgICAgICAgICAgcmVjb3JkLnNhdmVkX2F0ID0gcGF0aC5qb2luKHJlY29yZC5zYXZlZF9hdCwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKycoJytyZWNvcmQudGltZXN0YW1wKycpJytwYXRoLmV4dG5hbWUoZmlsZSkpOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZzLnJlbmFtZVN5bmMob2JqLnRtcCwgcmVjb3JkLnNhdmVkX2F0KTsKICAgICAgICAgICAgICAgICAgICBkdy5zdWNjZXNzKCdzYXZlZCByZXZpc2lvbiBmaWxlICcrcmVjb3JkLnNhdmVkX2F0KTsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZXgsICd3aGlsZSBzYXZpbmcgcmV2aXNpb24gZmlsZScpOwogICAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGR3LmVycm9yKGUpOwogICAgICAgICAgICAgICAgICBkdy53YXJuKCdjb3VsZCBub3QgY2hlY2sgLyB1c2UgJytyZWNvcmQuc2F2ZWRfYXQrJy4uIGRpZCBub3Qgc2F2ZSByZXZpc2lvbiBmaWxlIScpOwogICAgICAgICAgICAgICAgICAvLyBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgIC8vIG5vIGZpbGUgYmFzZWQgcmV2aXNpb24gaGlzdG9yeQogICAgICAgICAgICAgIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgfQogICAgICAgICAgZWxzZQogICAgICAgICAgewogICAgICAgICAgICAvLyBkaWZmIHdhcyBub3Qgc3VjY2Vzc2Z1bCAtIHdoeQogICAgICAgICAgICBkdy5lcnJvcignZGlmZiB1bnN1Y2Nlc3NmdWwgLSBmcm9tIGRpZmYgZW5naW5lOiAnKTsKICAgICAgICAgICAgZHcud2FybihKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcykpOwogICAgICB9CgogICAgfS5iaW5kKHRoaXMpKTsgLyogZmluZE9uZSAqLwogIH0uYmluZCh0aGlzKSk7IC8qIGNoYW5nZSAqLwoKICBkdy5pbmZvKCdzdGFydGVkIGNoZWNraW5nJyk7Cn0KCm1vZHVsZS5leHBvcnRzID0gZHc7Cg==","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000049130","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354204747,"_s":"6a04d9cae7dd7c6438b864fcfa27dd20"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354204737,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"},{"timestamp":1419354199360,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 09:03:19.340250400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:19.295220100 -0800\r\n@@ -68,6 +68,7 @@\r\n     }\r\n   });\r\n \r\n+  // see how that is\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354199360).js"},{"timestamp":1419354204735,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 09:03:24.714323100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:24.695309700 -0800\r\n@@ -69,6 +69,7 @@\r\n   });\r\n \r\n   // see how that is\r\n+  // actually works lmao\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354204735).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICAvLyBzZWUgaG93IHRoYXQgaXMKICAvLyBhY3R1YWxseSB3b3JrcyBsbWFvCiAgcHJvamVjdC51cGRhdGUoCiAgeyBfaWQ6IG9uZUlkIH0sCiAgewogICAga2V5OiBvYmoua2V5LAogICAgJHB1c2g6IHsgcmV2aXNpb25zOiByZWNvcmQgfQogIH0sCiAgZnVuY3Rpb24oZXJyLCByZXN1bHQpIHsKICAgIGlmIChlcnIgIT0gbnVsbCkgewogICAgICBkdy5lcnJvcignZXJyb3Igc2F2aW5nIHRvIGRiJywgZXJyKTsKICAgICAgZHcuZXJyb3IoZXJyLnN0YWNrKTsKICAgIH0KCiAgICBwcm9qZWN0LmZpbmRPbmUoeyBfaWQ6IG9uZUlkIH0sIGZ1bmN0aW9uKGVyciwgZW50cnkpewogICAgICAvLyBjaGVjayBmb3IgZXJyb3IKICAgICAgaWYgKGVyciAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoZXJyKTsKICAgICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gbWFrZSBzdXJlIGVudHJ5IGlzIHRoZXJlIC8gdXBkYXRlZCB0ZXN0CiAgICAgIGlmIChlbnRyeSAhPSBudWxsICYmIGVudHJ5LnJldmlzaW9ucyAhPSBudWxsKQogICAgICB7CiAgICAgICAgLy8gc2hvdyBlbnRyeSBpbmZvIC8gdGVzdCBkZWJ1ZwogICAgICAgIHZhciBsYXN0RGlmZiA9IGVudHJ5LnJldmlzaW9uc1tlbnRyeS5yZXZpc2lvbnMubGVuZ3RoLTFdLmRpZmYgfHwgbnVsbDsKICAgICAgICBkdy5pbmZvKCJyZXZpc2lvbiBoaXN0b3J5IGZvciAiK29uZUlkKyIgY29udGFpbnMgIitlbnRyeS5yZXZpc2lvbnMubGVuZ3RoKyIgZW50cmllcy4iKTsKICAgICAgICBkdy5kZWJ1ZygndXBkYXRlZCBkaWZmIGxlbmd0aDogJywgbGFzdERpZmYubGVuZ3RoKTsKICAgICAgICBkdy5kZWJ1ZygnbGFzdCBkaWZmOiAnLCBsYXN0RGlmZik7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoZW50cnkgIT0gbnVsbCkKICAgICAgewogICAgICAgIGR3LmVycm9yKCdyZXZpc2lvbiBoaXN0b3J5IGZvciAnK29uZUlkKycgbnVsbCcpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIGR3LmVycm9yKCdyZXZpc2lvbiBoaXN0b3J5IC8gZW50cnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgIH0pOwogIH0pOyAvLyB1cGRhdGUgY2FsbGJhY2sgKGZpcnN0KQp9IC8vIGZuOnVwZGF0ZQoKLy8gc3RhcnQgbGlzdGVuaW5nIHRvIGNoYW5nZSBldmVudHMgKGNhbGxlZCBhZnRlciByZWFkeSkKZGlmZndhdGNoLnByb3RvdHlwZS5jaGVjayA9IGZ1bmN0aW9uKCkgewogIC8vIGNsb3N1cmUgLyB0aGlzIHNjb3BlCiAgdmFyIHNjb3BlID0gdGhpczsKICB2YXIgZGIgPSBzY29wZS5kYjsKCiAgdGhpcy53YXRjaGVyLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihmaWxlLCBzdGF0cykgewogICAgaWYgKGZpbGUuaW5kZXhPZigndGVtcCcpICE9IC0xKSByZXR1cm47CgogICAgdmFyIG5hbWUgPSBmaWxlLnRvTG93ZXJDYXNlKCk7CiAgICBpZiAoKG5hbWUuaW5kZXhPZignLmxvY2FsZGlmZicpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKCdkYicpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKCdzdG9yYWdlJykgIT0gLTEpIHx8IChuYW1lLmluZGV4T2YodGhpcy5zdG9yYWdlKSAhPSAtMSkgfHwgKGZpbGUuaW5kZXhPZihuYW1lLmRiUGF0aCkgIT0gLTEpKSB7CiAgICAgIGR3LmRlYnVnKCdmaWxlIHVwZGF0ZWQgaW4gaW50ZXJuYWwgZGlycy4gaWdub3JpbmcnKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAvLyAgaWYgKGZpbGUuaW5kZXhPZignLmpzb24nKSAhPSAtMSkgcmV0dXJuOwogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcudHh0JykgIT0gLTEpIHJldHVybjsKCiAgICBkdy5kZWJ1ZygnRmlsZScsIGZpbGUsICdjaGFuZ2VkIHNpemUgdG8nLCBzdGF0cy5zaXplKTsKCiAgICB2YXIga2V5ID0gKGZpbGUrJycpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXFcvZywgJycpLnRvU3RyaW5nKCk7CiAgICB2YXIgcHJvamVjdCA9IHRoaXMucHJvamVjdDsKCiAgICAvLyBmaW5kIGV4aXN0aW5nIHJlY29yZCBieSBrZXkgaW4gZGIKICAgIHRoaXMucHJvamVjdC5maW5kT25lKHsga2V5OiBrZXkgfSwgZnVuY3Rpb24oZXJyLCBpdGVtKXsKICAgICAgaWYgKGVycikKICAgICAgewogICAgICAgIGR3LmVycm9yKCdkYicsIGVycik7CiAgICAgICAgZHcuZXJyb3IoJ3N0YWNrJywgZXJyLnN0YWNrKTsKICAgICAgICBkdy5pbmZvKCdrZXk6Jywga2V5KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChpdGVtID09IG51bGwpIHsKICAgICAgICBkdy5kZWJ1Zygnbm8gaXRlbSBmb3VuZCBmb3Iga2V5OicsIGtleSk7CgogICAgICAgIGlmIChvcmlnaW5hbHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAvLyBpZiB3ZSBoYXZlIHRoZSBvcmlnaW5hbCBzdGF0ZSBvZiB0aGUgZmlsZQogICAgICAgICAgLy8gYW5kIGl0J3MgY2hhbmdlZCwgZGlmZiBmcm9tIHRoYXQKICAgICAgICAgIGRpZmYoZmlsZSwgb3JpZ2luYWxzW2tleV0sIGZ1bmN0aW9uKHN1Y2Nlc3MsIG9iail7CiAgICAgICAgICAgIGlmIChzdWNjZXNzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSBtZXcgcmV2aXNpb24gcmVjb3JkCiAgICAgICAgICAgICAgdmFyIHJlY29yZCA9IHsgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwgZGlmZjogb2JqLmRpZmYgfTsKCiAgICAgICAgICAgICAgcHJvamVjdC5pbnNlcnQoewogICAgICAgICAgICAgICAga2V5OiBvYmoua2V5LAogICAgICAgICAgICAgICAgcGF0aDogZmlsZSwKICAgICAgICAgICAgICAgIGxhc3RVcGRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgICAgICAgICAgcmV2aXNpb25zOiBbIHJlY29yZCBdLAoKICAgICAgICAgICAgICAgIHByZXZpb3VzOiBvYmoudGV4dC50b1N0cmluZygnYmFzZTY0JyksCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3RyYWNraW5nIG5ldyBmaWxlICcrZmlsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZHcud2Fybignb3JpZ2luYWwgZGlmZiBmYWlsZWQgZm9yICcrZmlsZSsiIGluZm86ICIrSlNPTi5zdHJpbmdpZnkob2JqKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIGR3LmluZm8oJ3dpbGwgdHJhY2sgJytmaWxlKycgb24gbmV4dCBjaGFuZ2UgKHdhaXRpbmcgZm9yIG5ldyB2ZXJzaW9uKScpOwogICAgICAgICAgb3JpZ2luYWxzW2tleV0gPSBmcy5yZWFkRmlsZVN5bmMoZmlsZSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZHcuZXJyb3IoJ2RpZmYgY291bGQgbm90IGZpbmQgaXRlbSB3LyBrZXk6JytrZXkrJyBmb3IgZmlsZTonK2ZpbGUrJyAvIGRpZCBub3RoaW5nIGFib3V0IGl0LicpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gdXBkYXRlZAogICAgICBpZiAoaXRlbSAhPSBudWxsICYmIGl0ZW0ucHJldmlvdXMpCiAgICAgIHsKICAgICAgICB2YXIgb25lSWQgPSBpdGVtLl9pZDsKICAgICAgICBkdy5kZWJ1ZygnZXhpc3RpbmcgaXRlbSBrZXk6ICcsIGl0ZW0ua2V5LCAnIGlkOicsIG9uZUlkKTsKCiAgICAgICAgLy9kdy5kZWJ1ZygnaXRlbSBpZDonLCBvbmVJZCk7CiAgICAgICAgLy9kdy5kZWJ1ZygncnVubmluZyBkaWZmIGZvciAnK2ZpbGUrJyAvIGtleSAnK2l0ZW0ua2V5KTsKCiAgICAgICAgLy8gZmlsZSBoYXMgYSBsYXRlc3QgdmVyc2lvbiBzdG9yZWQgaW4gdGhlIGRiLCBzbyBkaWZmIGFnYWluc3QgdGhhdCBhbmQgc2F2ZSByZXN1bHQKICAgICAgICAvLyBhdCB0aGlzIHBvaW50LCBsYXRlc3Qgc2hvdWxkIGJlIHRoZSBsYXN0IHJldmlzaW9uCiAgICAgICAgZGlmZihmaWxlLCBuZXcgQnVmZmVyKGl0ZW0ucHJldmlvdXMsICdiYXNlNjQnKSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgIC8vIHVwZGF0ZQogICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIHd0Ziwgd2h5IHdvdWxkbid0IGl0ZW0gYiBoZXJlCiAgICAgICAgICAgIGR3LmRlYnVnKCdnb3QgbmV3IGRpZmYgZm9yICcrZmlsZSsnIHdpdGggaWQgJytvbmVJZCk7CgogICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwogICAgICAgICAgICBpZiAoc2NvcGUuZGJIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgIGR3LmRlYnVnKCdzYXZpbmcgaGlzdG9yeSBpbiBEQiBmb3InLCBvbmVJZCkKICAgICAgICAgICAgICAgcmVjb3JkLnRleHQgPSBvYmoudGV4dDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIHVzaW5nIHJldmlzaW9uIGhpc3RvcnksIG1vdmUgdGhlIHRtcCBmaWxlIHRvIHN0b3JhZ2UgLSB0aGVuIGNhbGwgdXBkYXRlLCBvciBjYWxsIHVwZGF0ZSB3aGVuCiAgICAgICAgICAgIC8vIGZpbmlzaGVkLgogICAgICAgICAgICBpZiAoc2NvcGUucmV2SGlzdG9yeSkKICAgICAgICAgICAgewogICAgICAgICAgICAgIC8vIGJhc2UgcGF0aCAoaWUgZm9sZGVyIG5hbWUgd2l0aG91dCBleHRlbnNpb24pCiAgICAgICAgICAgICAgcmVjb3JkLnNhdmVkX2F0ID0gcGF0aC5qb2luKHNjb3BlLnN0b3JhZ2UsIHBhdGguYmFzZW5hbWUoZmlsZSwgcGF0aC5leHRuYW1lKGZpbGUpKSsnLXJldnMnKTsKCiAgICAgICAgICAgICAgLy8gY3JlYXRlIHRoZSByZXZpc2lvbnMgZm9sZGVyCiAgICAgICAgICAgICAgZnMubWtkaXIocmVjb3JkLnNhdmVkX2F0LGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgaWYoIWUgfHwgKGUgJiYgZS5jb2RlID09PSAnRUVYSVNUJykpIHsKICAgICAgICAgICAgICAgICAgcmVjb3JkLnNhdmVkX2F0ID0gcGF0aC5qb2luKHJlY29yZC5zYXZlZF9hdCwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKycoJytyZWNvcmQudGltZXN0YW1wKycpJytwYXRoLmV4dG5hbWUoZmlsZSkpOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZzLnJlbmFtZVN5bmMob2JqLnRtcCwgcmVjb3JkLnNhdmVkX2F0KTsKICAgICAgICAgICAgICAgICAgICBkdy5zdWNjZXNzKCdzYXZlZCByZXZpc2lvbiBmaWxlICcrcmVjb3JkLnNhdmVkX2F0KTsKCiAgICAgICAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZXgsICd3aGlsZSBzYXZpbmcgcmV2aXNpb24gZmlsZScpOwogICAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGR3LmVycm9yKGUpOwogICAgICAgICAgICAgICAgICBkdy53YXJuKCdjb3VsZCBub3QgY2hlY2sgLyB1c2UgJytyZWNvcmQuc2F2ZWRfYXQrJy4uIGRpZCBub3Qgc2F2ZSByZXZpc2lvbiBmaWxlIScpOwogICAgICAgICAgICAgICAgICAvLyBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgIC8vIG5vIGZpbGUgYmFzZWQgcmV2aXNpb24gaGlzdG9yeQogICAgICAgICAgICAgIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgfQogICAgICAgICAgZWxzZQogICAgICAgICAgewogICAgICAgICAgICAvLyBkaWZmIHdhcyBub3Qgc3VjY2Vzc2Z1bCAtIHdoeQogICAgICAgICAgICBkdy5lcnJvcignZGlmZiB1bnN1Y2Nlc3NmdWwgLSBmcm9tIGRpZmYgZW5naW5lOiAnKTsKICAgICAgICAgICAgZHcud2FybihKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgIH0KICAgICAgICB9LmJpbmQodGhpcykpOwogICAgICB9CgogICAgfS5iaW5kKHRoaXMpKTsgLyogZmluZE9uZSAqLwogIH0uYmluZCh0aGlzKSk7IC8qIGNoYW5nZSAqLwoKICBkdy5pbmZvKCdzdGFydGVkIGNoZWNraW5nJyk7Cn0KCm1vZHVsZS5leHBvcnRzID0gZHc7Cg==","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000049094","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354210400,"_s":"672ac9ce0f1fce1796d269d262de2208"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354210398,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"},{"timestamp":1419354199360,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 09:03:19.340250400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:19.295220100 -0800\r\n@@ -68,6 +68,7 @@\r\n     }\r\n   });\r\n \r\n+  // see how that is\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354199360).js"},{"timestamp":1419354204735,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 09:03:24.714323100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:24.695309700 -0800\r\n@@ -69,6 +69,7 @@\r\n   });\r\n \r\n   // see how that is\r\n+  // actually works lmao\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354204735).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICAvLyBzZWUgaG93IHRoYXQgaXMKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgdmFyIGxhc3REaWZmID0gZW50cnkucmV2aXNpb25zW2VudHJ5LnJldmlzaW9ucy5sZW5ndGgtMV0uZGlmZiB8fCBudWxsOwogICAgICAgIGR3LmluZm8oInJldmlzaW9uIGhpc3RvcnkgZm9yICIrb25lSWQrIiBjb250YWlucyAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBsYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGxhc3REaWZmKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
{"k":"0000000078","o":"0000049534","v":"001"}
{"_id":3,"_uid":4,"_dt":1419354210404,"_s":"2b8e647eaf858d637b96b729f3f9f2e2"}
{"key":"clocaldiffdiffwatchjs","path":"C:\\localdiff\\diffwatch.js","lastUpdate":1419354210398,"revisions":[{"timestamp":1419353394175,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n"},{"timestamp":1419353401445,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:50:01.415164800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:01.408159000 -0800\r\n@@ -92,7 +92,6 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353401445).js"},{"timestamp":1419353409777,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 08:50:09.742771100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:09.731763800 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353409777).js"},{"timestamp":1419353418758,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 08:50:18.738819400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:18.728811600 -0800\r\n@@ -92,7 +92,7 @@\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n-\r\n+        // test\r\n         //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n         //dw.debug('wrote debug test.json');\r\n       }\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353418758).js"},{"timestamp":1419353428553,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 08:50:28.525648000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:28.520644300 -0800\r\n@@ -93,8 +93,6 @@\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n \r\n \r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353428553).js"},{"timestamp":1419353430737,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 08:50:30.705135900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:50:30.698131300 -0800\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353430737).js"},{"timestamp":1419353636569,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 08:53:56.538421400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:53:56.527414800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353636569).js"},{"timestamp":1419353661120,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js9\t2014-12-23 08:54:21.098219600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:21.079207000 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353661120).js"},{"timestamp":1419353664924,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js10\t2014-12-23 08:54:24.904970300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:24.895963900 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353664924).js"},{"timestamp":1419353675423,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js11\t2014-12-23 08:54:35.404746500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:35.394740200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -91,10 +91,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353675423).js"},{"timestamp":1419353695514,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js12\t2014-12-23 08:54:55.482563800 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:54:55.476559800 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353695514).js"},{"timestamp":1419353726143,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js13\t2014-12-23 08:55:26.121330400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:26.100317200 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353726143).js"},{"timestamp":1419353727730,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js14\t2014-12-23 08:55:27.712277900 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:27.700270700 -0800\r\n@@ -53,7 +53,7 @@\r\n var originals = {};\r\n \r\n // update block to be called after saving other info\r\n-diffwatch.prototype.update = function update(obj, record, oneId) {\r\n+diffwatch.prototype.update = function update(obj, record, oneId, lastDiff) {\r\n   // update debug (test)\r\n   dw.debug('updating id '+oneId, 'type of ',typeof(oneId));\r\n   dw.debug('update diff length: ', obj.diff.length);\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353727730).js"},{"timestamp":1419353738215,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js15\t2014-12-23 08:55:38.195514500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:55:38.148483300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -91,10 +90,6 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353738215).js"},{"timestamp":1419353782733,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js16\t2014-12-23 08:56:22.715108600 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:22.686089000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353782733).js"},{"timestamp":1419353788144,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js17\t2014-12-23 08:56:28.124201700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:28.104186900 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353788144).js"},{"timestamp":1419353789427,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js18\t2014-12-23 08:56:29.408318100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:29.395310200 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353789427).js"},{"timestamp":1419353797426,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js19\t2014-12-23 08:56:37.408045700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:37.396037300 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -88,13 +87,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353797426).js"},{"timestamp":1419353815946,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 08:56:55.911632300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:56:55.878608000 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353815946).js"},{"timestamp":1419353821269,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:57:01.243852300 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:01.227841700 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -84,17 +83,15 @@\r\n         return;\r\n       }\r\n \r\n+      // test (yes)\r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +158,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353821269).js"},{"timestamp":1419353828222,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 08:57:08.201778700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:57:08.179762500 -0800\r\n@@ -65,7 +65,6 @@\r\n   {\r\n     key: obj.key,\r\n     previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n     lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n@@ -83,18 +82,15 @@\r\n         dw.error(err.stack);\r\n         return;\r\n       }\r\n-\r\n+      \r\n       // make sure entry is there / updated test\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +157,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419353828222).js"},{"timestamp":1419354112718,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:01:52.683666400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:01:52.663653900 -0800\r\n@@ -64,9 +64,7 @@\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n+    \r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +86,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +156,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354112718).js"},{"timestamp":1419354148288,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js5\t2014-12-23 09:02:28.250242400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:28.236232700 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354148288).js"},{"timestamp":1419354158563,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js6\t2014-12-23 09:02:38.545188400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.528176300 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158563).js"},{"timestamp":1419354158852,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js7\t2014-12-23 09:02:38.833371700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:38.816359600 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354158852).js"},{"timestamp":1419354164115,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js8\t2014-12-23 09:02:44.097727000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:02:44.063704800 -0800\r\n@@ -60,13 +60,17 @@\r\n \r\n   var project = this.project;\r\n \r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +92,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +162,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354164115).js"},{"timestamp":1419354189672,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js1\t2014-12-23 09:03:09.646191500 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:09.592154000 -0800\r\n@@ -60,13 +60,18 @@\r\n \r\n   var project = this.project;\r\n \r\n+  // try and update this with set first\r\n+  project.update({ _id: oneId }, {\r\n+    \"$set\": {\r\n+      previous: obj.text.toString('base64'),\r\n+      lastUpdate: new Date().getTime()\r\n+    }\r\n+  });\r\n+\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n     key: obj.key,\r\n-    previous: obj.text.toString('base64'),\r\n-    lastDiff: obj.diff,\r\n-    lastUpdate: new Date().getTime(),\r\n     $push: { revisions: record }\r\n   },\r\n   function(err, result) {\r\n@@ -88,13 +93,10 @@\r\n       if (entry != null && entry.revisions != null)\r\n       {\r\n         // show entry info / test debug\r\n-        dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n-        dw.debug('updated diff length: ', entry.lastDiff.length);\r\n-        dw.debug('last diff: ', entry.lastDiff);\r\n-\r\n-\r\n-        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n-        //dw.debug('wrote debug test.json');\r\n+        var lastDiff = entry.revisions[entry.revisions.length-1].diff || null;\r\n+        dw.info(\"revision history for \"+oneId+\" contains \"+entry.revisions.length+\" entries.\");\r\n+        dw.debug('updated diff length: ', lastDiff.length);\r\n+        dw.debug('last diff: ', lastDiff);\r\n       }\r\n       else if (entry != null)\r\n       {\r\n@@ -161,7 +163,6 @@\r\n                 revisions: [ record ],\r\n \r\n                 previous: obj.text.toString('base64'),\r\n-                lastDiff: obj.diff,\r\n               });\r\n \r\n               dw.success('tracking new file '+file);\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354189672).js"},{"timestamp":1419354199360,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 09:03:19.340250400 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:19.295220100 -0800\r\n@@ -68,6 +68,7 @@\r\n     }\r\n   });\r\n \r\n+  // see how that is\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354199360).js"},{"timestamp":1419354204735,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js3\t2014-12-23 09:03:24.714323100 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:24.695309700 -0800\r\n@@ -69,6 +69,7 @@\r\n   });\r\n \r\n   // see how that is\r\n+  // actually works lmao\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354204735).js"},{"timestamp":1419354210396,"diff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js4\t2014-12-23 09:03:30.377183000 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 09:03:30.359169900 -0800\r\n@@ -69,7 +69,6 @@\r\n   });\r\n \r\n   // see how that is\r\n-  // actually works lmao\r\n   project.update(\r\n   { _id: oneId },\r\n   {\r\n","saved_at":"c:\\localdiff\\.localdiff\\storage\\diffwatch-revs\\diffwatch(1419354210396).js"}],"previous":"dmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyksCiAgICBjaG9raWRhciA9IHJlcXVpcmUoJ2Nob2tpZGFyJyksCiAgICBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKSwKICAgIGZzID0gcmVxdWlyZSgnZnMnKSwKICAgIHBhdGggPSByZXF1aXJlKCdwYXRoJyksCiAgICAvKiBjbGFzc2VzIC8gc3RhdGljIGltcG9ydHMgKi8KICAgIGV4ZWMgPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5leGVjLAogICAgc3Bhd24gPSByZXF1aXJlKCdjaGlsZC1wcm9jZXNzLXByb21pc2UnKS5zcGF3biwKICAgIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCnZhciBkdyA9IHJlcXVpcmUoJy4vbW9kdWxlcy91dGlscycpLAogICAgbG9jYWxkaWZmID0gcmVxdWlyZSgnLi9tb2R1bGVzL2xvY2FsZGlmZicpOwoKdmFyIGRpZmYgPSBsb2NhbGRpZmYuZGlmZjsKCi8vIGFuIGV2ZW50ZW1pdHRlciwgZGlmZndhdGNoIGlzIHRoZSBtb2R1bGUgY29udGFpbmluZyB0aGUgbG9naWMgZm9yIHVwZGF0aW5nIHRoZSBtb25nb2RiLWNvbXBhdGlibGUgdGluZ29kYiBzZXR1cCBieSBpbmRleC5qcwovLyBhbmQgY3JlYXRpbmcgdGhlIHJlbGV2YW50IGNvbGxlY3Rpb25zIGZvciB0aGUgcGF0aC4KZnVuY3Rpb24gZGlmZndhdGNoKG9wdHMpCnsKICB0aGlzLnBhdGggPSBvcHRzLndvcmtpbmdQYXRoOwogIHRoaXMuZGIgPSBvcHRzLmRiOwogIHRoaXMuc3RvcmFnZSA9IG9wdHMuc3RvcmFnZURpci50b0xvd2VyQ2FzZSgpOwogIHRoaXMuZGJQYXRoID0gb3B0cy5kYlBhdGgudG9Mb3dlckNhc2UoKTsKCiAgdGhpcy5wcm9qZWN0ID0gb3B0cy5wcm9qZWN0OwogIHRoaXMucmV2SGlzdG9yeSA9IG9wdHMucmV2SGlzdG9yeTsKICB0aGlzLmRiSGlzdG9yeSA9IG9wdHMuZGJIaXN0b3J5OwoKICB0aGlzLnJlYWR5ID0gZmFsc2U7CgogIGR3LmN1cnJlbnQgPSB0aGlzOwogIGxvY2FsZGlmZi50ZW1wRGlyID0gb3B0cy50ZW1wUGF0aDsKICBsb2NhbGRpZmYuZ2V0RGlmZlBhdGgoZnVuY3Rpb24oKXsKICAgIGR3LmRlYnVnKCdzdGFydGluZyBkaWZmd2F0Y2gnKTsKICAgIHRoaXMuc3RhcnQoKTsKICB9LmJpbmQodGhpcykpOwp9CmRpZmZ3YXRjaC5wcm90b3R5cGUuX19wcm90b19fID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZTsKCi8vIGltcG9ydGFudCAtIHRoZSBjbGFzcyBnZXRzIGV4cG9zZWQgaGVyZQpkdy5EaWZmV2F0Y2hlciA9IGRpZmZ3YXRjaDsKCi8vIHN0YXJ0IHdhdGNoaW5nCmRpZmZ3YXRjaC5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgd2F0Y2hlciA9IHRoaXMud2F0Y2hlciA9IGNob2tpZGFyLndhdGNoKHRoaXMucGF0aCwge2lnbm9yZWQ6IC9bXC9cXF1cLi8sIHBlcnNpc3RlbnQ6IHRydWV9KTsKICB3YXRjaGVyLm9uKCdyZWFkeScsIGZ1bmN0aW9uKCkgewogICAgdXRpbC5sb2coJ1NjYW5uZWQgd29ya2luZyBkaXJlY3RvcnkuIHJlYWR5IGZvciBjaGFuZ2VzLi4nKTsKICAgIHRoaXMucmVhZHkgPSB0cnVlOwogICAgdGhpcy5jaGVjaygpOwogIH0uYmluZCh0aGlzKSk7Cn0KCnZhciBvcmlnaW5hbHMgPSB7fTsKCi8vIHVwZGF0ZSBibG9jayB0byBiZSBjYWxsZWQgYWZ0ZXIgc2F2aW5nIG90aGVyIGluZm8KZGlmZndhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKSB7CiAgLy8gdXBkYXRlIGRlYnVnICh0ZXN0KQogIGR3LmRlYnVnKCd1cGRhdGluZyBpZCAnK29uZUlkLCAndHlwZSBvZiAnLHR5cGVvZihvbmVJZCkpOwogIGR3LmRlYnVnKCd1cGRhdGUgZGlmZiBsZW5ndGg6ICcsIG9iai5kaWZmLmxlbmd0aCk7CgogIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAvLyB0cnkgYW5kIHVwZGF0ZSB0aGlzIHdpdGggc2V0IGZpcnN0CiAgcHJvamVjdC51cGRhdGUoeyBfaWQ6IG9uZUlkIH0sIHsKICAgICIkc2V0IjogewogICAgICBwcmV2aW91czogb2JqLnRleHQudG9TdHJpbmcoJ2Jhc2U2NCcpLAogICAgICBsYXN0VXBkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKQogICAgfQogIH0pOwoKICAvLyBzZWUgaG93IHRoYXQgaXMKICBwcm9qZWN0LnVwZGF0ZSgKICB7IF9pZDogb25lSWQgfSwKICB7CiAgICBrZXk6IG9iai5rZXksCiAgICAkcHVzaDogeyByZXZpc2lvbnM6IHJlY29yZCB9CiAgfSwKICBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewogICAgaWYgKGVyciAhPSBudWxsKSB7CiAgICAgIGR3LmVycm9yKCdlcnJvciBzYXZpbmcgdG8gZGInLCBlcnIpOwogICAgICBkdy5lcnJvcihlcnIuc3RhY2spOwogICAgfQoKICAgIHByb2plY3QuZmluZE9uZSh7IF9pZDogb25lSWQgfSwgZnVuY3Rpb24oZXJyLCBlbnRyeSl7CiAgICAgIC8vIGNoZWNrIGZvciBlcnJvcgogICAgICBpZiAoZXJyICE9IG51bGwpCiAgICAgIHsKICAgICAgICBkdy5lcnJvcihlcnIpOwogICAgICAgIGR3LmVycm9yKGVyci5zdGFjayk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBtYWtlIHN1cmUgZW50cnkgaXMgdGhlcmUgLyB1cGRhdGVkIHRlc3QKICAgICAgaWYgKGVudHJ5ICE9IG51bGwgJiYgZW50cnkucmV2aXNpb25zICE9IG51bGwpCiAgICAgIHsKICAgICAgICAvLyBzaG93IGVudHJ5IGluZm8gLyB0ZXN0IGRlYnVnCiAgICAgICAgdmFyIGxhc3REaWZmID0gZW50cnkucmV2aXNpb25zW2VudHJ5LnJldmlzaW9ucy5sZW5ndGgtMV0uZGlmZiB8fCBudWxsOwogICAgICAgIGR3LmluZm8oInJldmlzaW9uIGhpc3RvcnkgZm9yICIrb25lSWQrIiBjb250YWlucyAiK2VudHJ5LnJldmlzaW9ucy5sZW5ndGgrIiBlbnRyaWVzLiIpOwogICAgICAgIGR3LmRlYnVnKCd1cGRhdGVkIGRpZmYgbGVuZ3RoOiAnLCBsYXN0RGlmZi5sZW5ndGgpOwogICAgICAgIGR3LmRlYnVnKCdsYXN0IGRpZmY6ICcsIGxhc3REaWZmKTsKICAgICAgfQogICAgICBlbHNlIGlmIChlbnRyeSAhPSBudWxsKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgZm9yICcrb25lSWQrJyBudWxsJyk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ3JldmlzaW9uIGhpc3RvcnkgLyBlbnRyeSBmb3IgJytvbmVJZCsnIG51bGwnKTsKICAgICAgfQogICAgfSk7CiAgfSk7IC8vIHVwZGF0ZSBjYWxsYmFjayAoZmlyc3QpCn0gLy8gZm46dXBkYXRlCgovLyBzdGFydCBsaXN0ZW5pbmcgdG8gY2hhbmdlIGV2ZW50cyAoY2FsbGVkIGFmdGVyIHJlYWR5KQpkaWZmd2F0Y2gucHJvdG90eXBlLmNoZWNrID0gZnVuY3Rpb24oKSB7CiAgLy8gY2xvc3VyZSAvIHRoaXMgc2NvcGUKICB2YXIgc2NvcGUgPSB0aGlzOwogIHZhciBkYiA9IHNjb3BlLmRiOwoKICB0aGlzLndhdGNoZXIub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGZpbGUsIHN0YXRzKSB7CiAgICBpZiAoZmlsZS5pbmRleE9mKCd0ZW1wJykgIT0gLTEpIHJldHVybjsKCiAgICB2YXIgbmFtZSA9IGZpbGUudG9Mb3dlckNhc2UoKTsKICAgIGlmICgobmFtZS5pbmRleE9mKCcubG9jYWxkaWZmJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ2RiJykgIT0gLTEpIHx8IChmaWxlLmluZGV4T2YoJ3N0b3JhZ2UnKSAhPSAtMSkgfHwgKG5hbWUuaW5kZXhPZih0aGlzLnN0b3JhZ2UpICE9IC0xKSB8fCAoZmlsZS5pbmRleE9mKG5hbWUuZGJQYXRoKSAhPSAtMSkpIHsKICAgICAgZHcuZGVidWcoJ2ZpbGUgdXBkYXRlZCBpbiBpbnRlcm5hbCBkaXJzLiBpZ25vcmluZycpOwogICAgICByZXR1cm47CiAgICB9CgogIC8vICBpZiAoZmlsZS5pbmRleE9mKCcuanNvbicpICE9IC0xKSByZXR1cm47CiAgLy8gIGlmIChmaWxlLmluZGV4T2YoJy50eHQnKSAhPSAtMSkgcmV0dXJuOwoKICAgIGR3LmRlYnVnKCdGaWxlJywgZmlsZSwgJ2NoYW5nZWQgc2l6ZSB0bycsIHN0YXRzLnNpemUpOwoKICAgIHZhciBrZXkgPSAoZmlsZSsnJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9cVy9nLCAnJykudG9TdHJpbmcoKTsKICAgIHZhciBwcm9qZWN0ID0gdGhpcy5wcm9qZWN0OwoKICAgIC8vIGZpbmQgZXhpc3RpbmcgcmVjb3JkIGJ5IGtleSBpbiBkYgogICAgdGhpcy5wcm9qZWN0LmZpbmRPbmUoeyBrZXk6IGtleSB9LCBmdW5jdGlvbihlcnIsIGl0ZW0pewogICAgICBpZiAoZXJyKQogICAgICB7CiAgICAgICAgZHcuZXJyb3IoJ2RiJywgZXJyKTsKICAgICAgICBkdy5lcnJvcignc3RhY2snLCBlcnIuc3RhY2spOwogICAgICAgIGR3LmluZm8oJ2tleTonLCBrZXkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkgewogICAgICAgIGR3LmRlYnVnKCdubyBpdGVtIGZvdW5kIGZvciBrZXk6Jywga2V5KTsKCiAgICAgICAgaWYgKG9yaWdpbmFsc1trZXldKQogICAgICAgIHsKICAgICAgICAgIC8vIGlmIHdlIGhhdmUgdGhlIG9yaWdpbmFsIHN0YXRlIG9mIHRoZSBmaWxlCiAgICAgICAgICAvLyBhbmQgaXQncyBjaGFuZ2VkLCBkaWZmIGZyb20gdGhhdAogICAgICAgICAgZGlmZihmaWxlLCBvcmlnaW5hbHNba2V5XSwgZnVuY3Rpb24oc3VjY2Vzcywgb2JqKXsKICAgICAgICAgICAgaWYgKHN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIG1ldyByZXZpc2lvbiByZWNvcmQKICAgICAgICAgICAgICB2YXIgcmVjb3JkID0geyB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCBkaWZmOiBvYmouZGlmZiB9OwoKICAgICAgICAgICAgICBwcm9qZWN0Lmluc2VydCh7CiAgICAgICAgICAgICAgICBrZXk6IG9iai5rZXksCiAgICAgICAgICAgICAgICBwYXRoOiBmaWxlLAogICAgICAgICAgICAgICAgbGFzdFVwZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICByZXZpc2lvbnM6IFsgcmVjb3JkIF0sCgogICAgICAgICAgICAgICAgcHJldmlvdXM6IG9iai50ZXh0LnRvU3RyaW5nKCdiYXNlNjQnKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgZHcuc3VjY2VzcygndHJhY2tpbmcgbmV3IGZpbGUgJytmaWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkdy53YXJuKCdvcmlnaW5hbCBkaWZmIGZhaWxlZCBmb3IgJytmaWxlKyIgaW5mbzogIitKU09OLnN0cmluZ2lmeShvYmopKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgZHcuaW5mbygnd2lsbCB0cmFjayAnK2ZpbGUrJyBvbiBuZXh0IGNoYW5nZSAod2FpdGluZyBmb3IgbmV3IHZlcnNpb24pJyk7CiAgICAgICAgICBvcmlnaW5hbHNba2V5XSA9IGZzLnJlYWRGaWxlU3luYyhmaWxlKTsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBkdy5lcnJvcignZGlmZiBjb3VsZCBub3QgZmluZCBpdGVtIHcvIGtleTonK2tleSsnIGZvciBmaWxlOicrZmlsZSsnIC8gZGlkIG5vdGhpbmcgYWJvdXQgaXQuJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB1cGRhdGVkCiAgICAgIGlmIChpdGVtICE9IG51bGwgJiYgaXRlbS5wcmV2aW91cykKICAgICAgewogICAgICAgIHZhciBvbmVJZCA9IGl0ZW0uX2lkOwogICAgICAgIGR3LmRlYnVnKCdleGlzdGluZyBpdGVtIGtleTogJywgaXRlbS5rZXksICcgaWQ6Jywgb25lSWQpOwoKICAgICAgICAvL2R3LmRlYnVnKCdpdGVtIGlkOicsIG9uZUlkKTsKICAgICAgICAvL2R3LmRlYnVnKCdydW5uaW5nIGRpZmYgZm9yICcrZmlsZSsnIC8ga2V5ICcraXRlbS5rZXkpOwoKICAgICAgICAvLyBmaWxlIGhhcyBhIGxhdGVzdCB2ZXJzaW9uIHN0b3JlZCBpbiB0aGUgZGIsIHNvIGRpZmYgYWdhaW5zdCB0aGF0IGFuZCBzYXZlIHJlc3VsdAogICAgICAgIC8vIGF0IHRoaXMgcG9pbnQsIGxhdGVzdCBzaG91bGQgYmUgdGhlIGxhc3QgcmV2aXNpb24KICAgICAgICBkaWZmKGZpbGUsIG5ldyBCdWZmZXIoaXRlbS5wcmV2aW91cywgJ2Jhc2U2NCcpLCBmdW5jdGlvbihzdWNjZXNzLCBvYmopewogICAgICAgICAgLy8gdXBkYXRlCiAgICAgICAgICBpZiAoc3VjY2VzcykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gd3RmLCB3aHkgd291bGRuJ3QgaXRlbSBiIGhlcmUKICAgICAgICAgICAgZHcuZGVidWcoJ2dvdCBuZXcgZGlmZiBmb3IgJytmaWxlKycgd2l0aCBpZCAnK29uZUlkKTsKCiAgICAgICAgICAgIHZhciByZWNvcmQgPSB7IHRpbWVzdGFtcDogbmV3IERhdGUoKS5nZXRUaW1lKCksIGRpZmY6IG9iai5kaWZmIH07CiAgICAgICAgICAgIGlmIChzY29wZS5kYkhpc3RvcnkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgZHcuZGVidWcoJ3NhdmluZyBoaXN0b3J5IGluIERCIGZvcicsIG9uZUlkKQogICAgICAgICAgICAgICByZWNvcmQudGV4dCA9IG9iai50ZXh0OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgdXNpbmcgcmV2aXNpb24gaGlzdG9yeSwgbW92ZSB0aGUgdG1wIGZpbGUgdG8gc3RvcmFnZSAtIHRoZW4gY2FsbCB1cGRhdGUsIG9yIGNhbGwgdXBkYXRlIHdoZW4KICAgICAgICAgICAgLy8gZmluaXNoZWQuCiAgICAgICAgICAgIGlmIChzY29wZS5yZXZIaXN0b3J5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gYmFzZSBwYXRoIChpZSBmb2xkZXIgbmFtZSB3aXRob3V0IGV4dGVuc2lvbikKICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4oc2NvcGUuc3RvcmFnZSwgcGF0aC5iYXNlbmFtZShmaWxlLCBwYXRoLmV4dG5hbWUoZmlsZSkpKyctcmV2cycpOwoKICAgICAgICAgICAgICAvLyBjcmVhdGUgdGhlIHJldmlzaW9ucyBmb2xkZXIKICAgICAgICAgICAgICBmcy5ta2RpcihyZWNvcmQuc2F2ZWRfYXQsZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighZSB8fCAoZSAmJiBlLmNvZGUgPT09ICdFRVhJU1QnKSkgewogICAgICAgICAgICAgICAgICByZWNvcmQuc2F2ZWRfYXQgPSBwYXRoLmpvaW4ocmVjb3JkLnNhdmVkX2F0LCBwYXRoLmJhc2VuYW1lKGZpbGUsIHBhdGguZXh0bmFtZShmaWxlKSkrJygnK3JlY29yZC50aW1lc3RhbXArJyknK3BhdGguZXh0bmFtZShmaWxlKSk7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvYmoudG1wLCByZWNvcmQuc2F2ZWRfYXQpOwogICAgICAgICAgICAgICAgICAgIGR3LnN1Y2Nlc3MoJ3NhdmVkIHJldmlzaW9uIGZpbGUgJytyZWNvcmQuc2F2ZWRfYXQpOwoKICAgICAgICAgICAgICAgICAgICBzY29wZS51cGRhdGUob2JqLCByZWNvcmQsIG9uZUlkKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICBkdy5lcnJvcihleCwgJ3doaWxlIHNhdmluZyByZXZpc2lvbiBmaWxlJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZHcuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgIGR3Lndhcm4oJ2NvdWxkIG5vdCBjaGVjayAvIHVzZSAnK3JlY29yZC5zYXZlZF9hdCsnLi4gZGlkIG5vdCBzYXZlIHJldmlzaW9uIGZpbGUhJyk7CiAgICAgICAgICAgICAgICAgIC8vIHNjb3BlLnVwZGF0ZShvYmosIHJlY29yZCwgb25lSWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gbm8gZmlsZSBiYXNlZCByZXZpc2lvbiBoaXN0b3J5CiAgICAgICAgICAgICAgc2NvcGUudXBkYXRlKG9iaiwgcmVjb3JkLCBvbmVJZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIGRpZmYgd2FzIG5vdCBzdWNjZXNzZnVsIC0gd2h5CiAgICAgICAgICAgIGR3LmVycm9yKCdkaWZmIHVuc3VjY2Vzc2Z1bCAtIGZyb20gZGlmZiBlbmdpbmU6ICcpOwogICAgICAgICAgICBkdy53YXJuKEpTT04uc3RyaW5naWZ5KG9iaikpOwogICAgICAgICAgfQogICAgICAgIH0uYmluZCh0aGlzKSk7CiAgICAgIH0KCiAgICB9LmJpbmQodGhpcykpOyAvKiBmaW5kT25lICovCiAgfS5iaW5kKHRoaXMpKTsgLyogY2hhbmdlICovCgogIGR3LmluZm8oJ3N0YXJ0ZWQgY2hlY2tpbmcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBkdzsK","lastDiff":"--- C:\\localdiff\\.localdiff\\db\\temp\\diffwatch.js2\t2014-12-23 08:49:54.128617700 -0800\r\n+++ C:\\localdiff\\diffwatch.js\t2014-12-23 08:49:54.124614600 -0800\r\n@@ -91,6 +91,10 @@\r\n         dw.info(\"revision history for \"+oneId+\": \"+entry.revisions.length+\" entries.\");\r\n         dw.debug('updated diff length: ', entry.lastDiff.length);\r\n         dw.debug('last diff: ', entry.lastDiff);\r\n+\r\n+\r\n+        //fs.writeFileSync('test.json', JSON.stringify(entry));\r\n+        //dw.debug('wrote debug test.json');\r\n       }\r\n       else if (entry != null)\r\n       {\r\n","_id":{"$wrap":"$oid","v":3}}
